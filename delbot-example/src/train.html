<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TensorFlow.js Model mouse</title>

  <!-- Import TensorFlow.js and tfjs-vis -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.0.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.5.1/dist/tfjs-vis.umd.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@chrisgdt/delbot-mouse@1.2.0/dist/delbot.js"></script>
  <!--script src="../../delbot-core/dist/delbot.js"></script-->

  <script src="https://cdn.jsdelivr.net/npm/@chrisgdt/delbot-training@1.2.0/dist/delbot-training.js"></script>
  <!--script src="../../delbot-training/dist/delbot-training.js"></script-->

  <script>
    const filePath = "../../python/sessions.json";
    const numClasses = 2;
    const dataMatrix = new delbotrain.DataTraining({filePath, data: new delbot.data.DataMovementMatrix({numClasses})});
    const dataSimplePos = new delbotrain.DataTraining({filePath, data: new delbot.data.DataSimplePosition({numClasses})});
    const dataOffsetPos = new delbotrain.DataTraining({filePath, data: new delbot.data.DataOffsetPosition({numClasses})});
    const dataFeatures2 = new delbotrain.DataTraining({filePath, data: new delbot.data.DataFeatures2({xSize: 24, numClasses})});

    const modelConvMovement = new delbotrain.ModelConvolutional({
      dataTraining: dataMatrix,
      nameToSave: "downloads://model-conv-matrix",
      epoch: 30,
      useTfjsVis: true,
      consoleInfo: true,
      optimizer: tf.train.adam(.001),
    }); // human 0.9212 406, bot 0.8047 594 -> 85.1%

    const modelDenseMatrix = new delbotrain.ModelDense({
      dataTraining: dataMatrix,
      nameToSave: "downloads://model-dense-matrix",
      epoch: 15,
      useTfjsVis: true,
      consoleInfo: true
    }); // human 0.8839 422, bot 0.8945 578 -> 89%
    const modelDenseFeatures = new delbotrain.ModelDense({
      dataTraining: dataFeatures2,
      nameToSave: "downloads://model-features2",
      epoch: 30,
      useTfjsVis: true,
      consoleInfo: true
    }); // human 0.8817 465, bot 0.6785 535 -> 77.3%
    const modelDenseSimplePos = new delbotrain.ModelDense({
      dataTraining: dataSimplePos,
      nameToSave: "downloads://model-dense-simple-pos",
      epoch: 30,
      useTfjsVis: true,
      consoleInfo: true
    }); // human 0.3924 446, bot 0.7852 554 -> 61%
    const modelDenseOffsetPos = new delbotrain.ModelDense({
      dataTraining: dataOffsetPos,
      nameToSave: "downloads://model-dense-offset-pos",
      epoch: 30,
      useTfjsVis: true,
      consoleInfo: true
    }); // human	0.8546	454, bot 0.3681 546 -> 58.9%

    const rnnSimplePos = new delbotrain.ModelRNN3({
      dataTraining: dataSimplePos,
      nameToSave: "downloads://model-rnn-simple-pos",
      epoch: 15,
      useTfjsVis: true,
      consoleInfo: true
    }); // human 0.3493 458, bot 0.8948 542 -> 64.5%
    const rnnOffsetPos = new delbotrain.ModelRNN3({
      dataTraining: dataOffsetPos,
      nameToSave: "downloads://model-rnn-offset-pos",
      epoch: 15,
      useTfjsVis: true,
      consoleInfo: true
    }); // don't converge (100% bot)

    class ModelRNN1Smaller extends delbotrain.TensorFlowModel {
      initModel() {
        const model = tf.sequential();

        model.add(tf.layers.lstm({
          inputShape: [null, this.data.data.getYSize()],
          units: 64,
          returnSequences: true,
          recurrentDropout : .5,
        }));
        model.add(tf.layers.batchNormalization());
        model.add(tf.layers.leakyReLU({alpha: .1}));
        model.add(tf.layers.dropout({rate:0.3}));

        model.add(tf.layers.lstm({
          units: 32,
          returnSequences: false,
          recurrentDropout : .8,
        }));
        model.add(tf.layers.leakyReLU({alpha: .1}));
        model.add(tf.layers.dropout({rate:0.1}));

        return model;
      }
    }

    class DataFeatures3 extends delbot.data.DataFeatures {
      constructor(args={}) {
        super(args);
        this.ySize = 13;
      }

      getChunkElement(line) {
        return [
          line.dx, line.dy,
          line.speedX, line.speedY,
          line.speed, line.accel,
          line.distance, line.angle,
          line.jerk,
          line.averageSpeedAgainstDistance,
          line.averageAccelAgainstDistance,
          line.speedXAgainstDistance, line.speedYAgainstDistance
        ]
      }
    }

    const rnn1Features2 = new delbotrain.ModelRNN({
      dataTraining: dataFeatures2,
      nameToSave: "downloads://model-rnn1-features3",
      epoch: 35,
      useTfjsVis: true,
      consoleInfo: true,
      batchSize: 256
    }); // human 0.9965 284, bot 0.9846 716 -> 98.8%
    const rnn2Features2 = new delbotrain.ModelRNN2({
      dataTraining: dataFeatures2,
      nameToSave: "downloads://model-rnn2-features2",
      epoch: 25,
      useTfjsVis: true,
      consoleInfo: false,
      batchSize: 256
    }); // human 0.7954 479, bot 0.453 521 -> 61.7%
    const rnn3Features2 = new delbotrain.ModelRNN3({
      dataTraining: dataFeatures2,
      nameToSave: "downloads://model-rnn3-features2",
      epoch: 35,
      optimizer: tf.train.adam(2e-4, .5, .99, 1e-8),
      useTfjsVis: true,
      consoleInfo: true,
      batchSize: 256
    }); // human 0.9617 287, bot 0.9621 713 -> 96.2%


    const rnn1SmallerFeatures2 = new ModelRNN1Smaller({
      dataTraining: dataFeatures2,
      nameToSave: "downloads://model-rnn1-faster-features2",
      epoch: 30,
      useTfjsVis: true,
      consoleInfo: true,
      batchSize: 256
    }); // human	0.9964	278, bot	0.9681	722


    const rfFeature2 = new delbotrain.RandomForestModel({
      dataTraining: new delbotrain.DataTraining({filePath, data: new delbot.data.DataFeatures2({numClasses:1})}),
      nameToSave: "random-forest-features2",
      useTfjsVis: true,
      consoleInfo: true,
      epoch: 1,
      batchSize: 4096
    }); // batch 1024 : human 0.9017 346, bot 0.9587 654 -> 93.9%


    const rnn3Testing = new delbotrain.ModelRNN3({
      dataTraining: dataFeatures2,
      nameToLoad: "https://raw.githubusercontent.com/chrisgdt/DELBOT-Mouse/master/trained-models/rnn3/model-rnn3-features2.json",
      useTfjsVis: true,
      consoleInfo: true
    });
    const rfTesting = new delbotrain.RandomForestModel({
      dataTraining: new delbotrain.DataTraining({filePath, data: new delbot.data.DataFeatures2({xSize: 24, numClasses: 1})}),
      nameToLoad: "https://raw.githubusercontent.com/chrisgdt/DELBOT-Mouse/master/trained-models/random-forest/random-forest-features2_1024.txt",
      useTfjsVis: true,
      consoleInfo: true
    });


    // Delay for tfjs-vis
    document.addEventListener('DOMContentLoaded', () => {rfFeature2.run()});
  </script>

</head>

<body>
</body>
</html>
